{{!-- Dolmenwood Combat Tracker --}}
<ol class="dolmen-combat-tracker" id="combat-tracker">

	{{!-- GM Toolbar: Pre-combat utility buttons --}}
	{{#if isGM}}
	<li class="dolmen-tracker-toolbar">
		<div class="toolbar-buttons">
			<button type="button" data-action="rollSurprise" data-tooltip="{{localize 'DOLMEN.Combat.SurpriseRoll'}}">
				<i class="fa-sharp fa-solid fa-seal-exclamation"></i>
			</button>
			<button type="button" data-action="rollEncounterDistance" data-tooltip="{{localize 'DOLMEN.Combat.EncounterDistance'}}">
				<i class="fa-duotone fa-solid fa-people-arrows"></i>
			</button>
			<button type="button" data-action="rollReaction" data-tooltip="{{localize 'DOLMEN.Combat.ReactionRoll'}}">
				<i class="fa-duotone fa-solid fa-masks-theater"></i>
			</button>
			<button type="button" data-action="rollMorale" data-tooltip="{{localize 'DOLMEN.Creature.MoraleCheck'}}">
				<i class="fa-solid fa-flag"></i>
			</button>
		</div>
	</li>
	{{/if}}

	{{!-- Grouped Combatant List --}}
	{{#each groups as |group|}}
	<li class="dolmen-group-header" style="border-left-color: {{group.color}}">
		<span class="group-name">{{group.label}}</span>
		<span class="group-initiative">
			{{#if group.hasInitiative}}
			<i class="fa-solid fa-dice-d6"></i> {{group.initiative}}
			{{else}}
			â€”
			{{/if}}
		</span>
	</li>

	{{#each group.combatants as |combatant|}}
	<li class="combatant dolmen-combatant {{#if combatant.isDefeated}}defeated{{/if}} {{#if combatant.hidden}}hidden-combatant{{/if}} {{#if combatant.active}}active{{/if}}"
		data-combatant-id="{{combatant.id}}"
		style="border-left-color: {{group.color}}">

		{{!-- Token Image --}}
		<div class="combatant-image" data-action="panToCombatant">
			<img src="{{combatant.img}}" alt="{{combatant.name}}">
			{{#if combatant.isDefeated}}
			<i class="fas fa-skull defeated-icon"></i>
			{{/if}}
		</div>

		{{!-- Name and Declaration --}}
		<div class="combatant-info">
			<span class="combatant-name">{{combatant.name}}</span>
			{{#if combatant.declarationIcon}}
			<span class="declaration-badge" data-tooltip="{{combatant.declarationTooltip}}">
				<i class="{{combatant.declarationIcon}}"></i>
			</span>
			{{/if}}
		</div>

		{{!-- Controls --}}
		<div class="combatant-controls">
			{{#if ../../isGM}}
				{{!-- Declaration Toggle --}}
				<a class="combatant-control" data-action="cycleDeclaration" data-tooltip="{{localize 'DOLMEN.Combat.Declaration.Toggle'}}">
					{{#if combatant.declaration}}
					<i class="{{combatant.declarationIcon}} active-declaration"></i>
					{{else}}
					<i class="fa-regular fa-comment-dots"></i>
					{{/if}}
				</a>

				{{!-- Hidden Toggle --}}
				<a class="combatant-control" data-action="toggleHidden" data-tooltip="{{localize 'COMBAT.ToggleVis'}}">
					<i class="fas {{#if combatant.hidden}}fa-eye-slash{{else}}fa-eye{{/if}}"></i>
				</a>

				{{!-- Defeated Toggle --}}
				<a class="combatant-control" data-action="toggleDefeated" data-tooltip="{{localize 'COMBAT.ToggleDead'}}">
					<i class="fas fa-skull {{#if combatant.isDefeated}}active{{/if}}"></i>
				</a>

				{{!-- Group Assignment --}}
				<a class="combatant-control group-assign" data-action="assignGroup" data-tooltip="{{localize 'DOLMEN.Combat.Group.Assign'}}" style="color: {{group.color}}">
					<i class="fa-solid fa-circle"></i>
				</a>
			{{else}}
				{{!-- Player: Declaration Toggle for own combatants --}}
				{{#if combatant.isOwner}}
				<a class="combatant-control" data-action="cycleDeclaration" data-tooltip="{{localize 'DOLMEN.Combat.Declaration.Toggle'}}">
					{{#if combatant.declaration}}
					<i class="{{combatant.declarationIcon}} active-declaration"></i>
					{{else}}
					<i class="fa-regular fa-comment-dots"></i>
					{{/if}}
				</a>
				{{/if}}
			{{/if}}
		</div>
	</li>
	{{/each}}
	{{/each}}

	{{!-- Empty State --}}
	{{#unless groups.length}}
	<li class="dolmen-tracker-empty">
		{{localize "COMBAT.None"}}
	</li>
	{{/unless}}
</ol>
